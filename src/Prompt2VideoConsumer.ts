import { EachMessagePayload } from "kafkajs";
import { startKafkaConsumer } from "./kafka/kafkaConsumer.js";
import { PodcastVideoProcessor } from "./PodcastVideoProcessor.js";
import { sendMessageToQueue } from "./utils/kafkaHelper.js";

interface KafkaMessagePayload {
    taskId?: string;
    accountId?: string;
    payload?: PromptPayload;
}

interface PromptPayload {
    prompt?: string;
    categoryHeading?: string;
    subitem?: string;
    impressionAlt?: string;
    accountId?: string;
}

const topic = 'prompt-to-video-dispatch';

function parseKafkaMessage(value: string): KafkaMessagePayload | null {
    try {
        return JSON.parse(value || '') as KafkaMessagePayload;
    } catch {
        console.error("âŒ Message is not valid JSON");
        return null;
    }
}

function logPayloadDetails(payload: PromptPayload) {
    console.log("ðŸ“ Payload:");
    if (payload.prompt) console.log("ðŸ’¬ Prompt:", payload.prompt);
    if (payload.categoryHeading) console.log("ðŸ·ï¸ Category Heading:", payload.categoryHeading);
    if (payload.subitem) console.log("ðŸ”¹ Subitem:", payload.subitem);
    if (payload.impressionAlt) console.log("ðŸ–¼ï¸ Impression Alt:", payload.impressionAlt);
    if (payload.accountId) console.log("ðŸ‘¥ Payload Account ID:", payload.accountId);
}

async function handlePromptToVideoTask(payload: PromptPayload, taskId: string | undefined, accountId: number | undefined) {
    const processor = new PodcastVideoProcessor();
    const finalOutputPath = await processor.processPodcastToVideo(payload.prompt!);

    if (finalOutputPath) {
        await sendMessageToQueue('prompt-to-video-response', {
            ...finalOutputPath,
            payload,
            taskId,
            accountId,
        });
    } else {
        console.log("âš ï¸ No output generated by processor.");
    }
}

startKafkaConsumer({
    topic,
    groupId: 'prompt2video-consumer',
    eachMessageHandler: async ({ message }: EachMessagePayload) => {
        const value = message.value?.toString() || '';
        console.log("ðŸ“© Received message:", value);

        const json = parseKafkaMessage(value);
        if (!json) return;
        console.log("ðŸ“¦ Parsed JSON:");

        if (json.taskId) console.log("ðŸ†” Task ID:", json.taskId);
        if (json.accountId) console.log("ðŸ‘¤ Account ID:", json.accountId);

        const payload = json.payload;
        if (payload?.prompt) {
            logPayloadDetails(payload);
            await handlePromptToVideoTask(payload, json.taskId, Number(json.accountId));
        }
    }
});
